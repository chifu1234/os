name: Chomium OS build
on: [push, workflow_dispatch]
jobs:
  chromium-os-build:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "üéâ Lets start by getting all deps"
          sudo apt update
          sudo apt-get install -y git-core curl lvm2 thin-provisioning-tools python-pkg-resources python3-virtualenv python3-oauth2client xz-utils python3.6
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git ~/depot_tools
          export PATH=~/depot_tools:$PATH 
          echo "üêß Now get the sources (around 30min)"
          mkdir ~/chromiumos
          cd ~/chromiumos
          repo init -u https://chromium.googlesource.com/chromiumos/manifest.git --repo-url https://chromium.googlesource.com/external/repo.git -g minilayout
          repo sync -j16 
          echo "üîé Now let's build chromium os (1h)."
          cros_sdk
          cros_sdk
          cros_sdk setup_board --board=amd64-generic
          cros_sdk ./build_packages --board=amd64-generic
          cros_sdk ./build_image --board=amd64-generic --noenable_rootfs_verification test
      - name: 'Upload Artifact'
        uses: actions/upload-artifact@v2
        with:
          name: chromiumos.bin
          path: ./src/build/images/amd64-generic/latest/chromiumos_test_image.bin
          retention-days: 5